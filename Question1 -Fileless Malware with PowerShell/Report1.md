# 🛡️ Scenario 1: Fileless Malware with PowerShell

## 🎯 Objective

Simulate and detect a fileless malware attack where a malicious PowerShell payload is executed in memory (no files dropped), commonly used in spear-phishing.

---

## 🧪 Attack Simulation

### ✅ Base64 Encoded PowerShell Payload

```powershell
$payload = 'Start-Process calc'
$bytes = [System.Text.Encoding]::Unicode.GetBytes($payload)
$encoded = [Convert]::ToBase64String($bytes)
powershell -EncodedCommand $encoded
```

### ✅ One-liner Execution

```powershell
powershell -EncodedCommand UwB0AGEAcgB0AC0AUAB... (Base64 payload)
```

---

## 📊 Detection with Sysmon + Winlogbeat

### 🧠 Key Sysmon Event IDs

| Event ID | Description                   |
|----------|-------------------------------|
| 1        | Process creation              |
| 10       | Process access (optional)     |

### 📂 Sample Event (Event ID 1)

```json
{
  "event_id": 1,
  "process.name": "powershell.exe",
  "process.command_line": "powershell.exe -EncodedCommand UwB...",
  "parent.process.name": "explorer.exe",
  "user.name": "WINVM\\user",
  "image": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
}
```

---

## 🔍 Kibana KQL Queries

```kql
winlog.event_id:1 AND process.name:"powershell.exe"
process.command_line.keyword: "*EncodedCommand*"
```



## 🛡️ Mitigation

- Enable PowerShell Constrained Language Mode.
- Monitor EncodedCommand usage.
- Use Defender ASR or EDRs to block suspicious PowerShell.
